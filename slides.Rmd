---
title: "Tidy Geospatial Networks in R"
subtitle: "Introducing the `sfnetworks` package"
author: "Lucas van der Meer, Lorena Abad, Andrea Gilardi, Robin Lovelace"
date: "2020-06-16 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js", "macro.js"]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16:9
---
class: center, middle

```{r setup, include = F}
# This is the recommended set up for flipbooks
# you might think about setting cache to TRUE as you gain practice --- building flipbooks from scratch can be time consuming
options(width = 70)
knitr::opts_chunk$set(
  fig.width = 6, message = FALSE, 
  warning = FALSE, comment = "", cache = FALSE, fig.retina = 3
)
knitr::opts_knit$set(global.par = TRUE)
# remotes::install_github("EvaMaeRey/flipbookr")
library(flipbookr)
# install('xaringanthemer')
library(xaringanthemer)
library(sfnetworks)
```

```{r xaringan-themer, include = F}
style_mono_accent(
  # hex color should be provided, or theme_xaringan doesn't work
  base_color = '#ffa500', #orange
  title_slide_background_image = "figs/milano.png",
  background_image = "figs/milano_bg.png",
  code_font_size = '14px',
  text_slide_number_color = '#b3b3b3', #grey70
  link_color = '#ff4500', #orangered  
  footnote_font_size = '0.5em',
  footnote_position_bottom = "30px",
  extra_css = list(
    ".pull-left-70" = list("float" = "left", "width" = "65.8%"),
    ".pull-right-30" = list("float" = "right", "width" = "28.2%"),
    ".pull-left-30" = list("float" = "left", "width" = "28.2%"),
    ".pull-right-70" = list("float" = "right", "width" = "65.8%")
  )
)
```

```{r color, echo = FALSE, results='asis'}
# crayon needs to be explicitly activated in Rmd
options(crayon.enabled = TRUE)
# Hooks needs to be set to deal with outputs
# thanks to fansi logic
old_hooks <- fansi::set_knit_hooks(knitr::knit_hooks,
                                   which = c("output", "message", "error"))
```

```{r, include = F, eval = F}
# Code to create scrolling bar / not working good with flipbookr
# ```{css, echo=FALSE}
# pre {
#   max-height: 90%;
#   overflow-y: auto;
#   background-color: inherit;
# }
# 
# pre[class] {
#   max-height: 50%;
# }
# ```
```

## Hello from the team!
.center[
![:scale 20%](https://avatars1.githubusercontent.com/u/26540305?s=400&u=c576e87314499815cbf698b7781ee58fd1d773e2&v=4)
![:scale 20%](https://pbs.twimg.com/profile_images/1107610946623754240/BaNA8k1E_400x400.png)
![:scale 20%](https://avatars1.githubusercontent.com/u/22221146?s=400&u=3683a04d3f40823162d6c1ae5c51b6c9a5c0a9a5&v=4)
![:scale 20%](https://avatars2.githubusercontent.com/u/10034237?s=460&u=53193bed2fad4f0808b55a227f99897a8d63ebc2&v=4)
]
--
.center[
what brought us together?
]
---
class: center, middle

## Geospatial Networks

--
.pull-left[
Road networks
![](figs/road_network.png)
]

--
.pull-right[
River networks
![](figs/river_network.png)
]

---

.pull-left-30[
## Geospatial in R

- \#rspatial
- sf
- stars
- ...

]


.pull-right-70[
```{r geospatial_r, dpi = 350, echo = F, strip.white = T, fig.dim = c(6,5), dev.args = list(bg = 'transparent'), out.width = '100%'}
library(ggplot2)
ggplot() +
  geom_sf(data = roxel) + 
  coord_sf(label_graticule = "NE") +
  theme(
    axis.ticks = element_line(color = 'grey70'),
    panel.grid = element_line(color = 'grey70', linetype = 'dotted', size = 0.5),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA)
  )
```

]
---

.pull-left-30[
## Networks in R

- igraph
- tidygraph
- ...

]

.pull-right-70[
```{r network_ex, dpi = 350, echo = F, strip.white = T, fig.dim = c(5,5), dev.args = list(bg = 'transparent'), out.width = '90%'}
library(ggraph)
library(tidygraph)
graph = roxel %>% as_sfnetwork(directed = F) %>% convert(to_components)
ggraph(graph, 'focus', focus = node_is_center()) +
  ggforce::geom_circle(
    aes(x0 = 0, y0 = 0, r = r), 
    data.frame(r = 1:20), colour = 'grey'
  ) +
  geom_edge_link() +
  geom_node_point(color = 'orangered') +
  coord_fixed() +
  theme(
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA)
  )
```
]

---
class: center, middle

# then...

## why a new package?

---

.center[
## why a new package?

![](figs/so_q1.png)
]

---

.center[
## why a new package?

![:scale 80%](figs/gh_q1.png)
]

---

.center[
## why a new package?

![](figs/gh_c1.png)
]

---
class: center
## why a new package?

<center><blockquote class="twitter-tweet"><p lang="en" dir="ltr">One of the biggest reasons we still have ArcGIS licenses is for Network Analysis (drive times, service areas etc). Does anyone have <a href="https://twitter.com/hashtag/foss4g?src=hash&amp;ref_src=twsrc%5Etfw">#foss4g</a> tools for this they like? Last time we tried pgRouting (yrs ago) it didn&#39;t feel fully formed yet, <a href="https://twitter.com/hashtag/gischat?src=hash&amp;ref_src=twsrc%5Etfw">#gischat</a></p>&mdash; Zev Ross (@zevross) <a href="https://twitter.com/zevross/status/1089908839816794118?ref_src=twsrc%5Etfw">January 28, 2019</a></blockquote></center> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

--

...

because open source can always get better!

---
class: center, middle

## What do we propose?

--
.pull-left[
![](https://user-images.githubusercontent.com/520851/34887433-ce1d130e-f7c6-11e7-83fc-d60ad4fae6bd.gif)
]

--

.pull-right[
![:scale 38%](https://raw.githubusercontent.com/thomasp85/tidygraph/master/man/figures/logo.png)
]
--

## `sfnetworks`

The best of both worlds!
---
class: middle

.pull-left-70[
.center[
![:scale 80%](https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/tidyverse_celestial.png)
]
.footnote[
Artwork by [@allison_horst](https://twitter.com/allison_horst)
]
]

.pull-right-30[
### *tidy* workflows
> In tidy data:
1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table.

.footnote[
Wickham, H. (2014). Tidy Data. Journal of Statistical Software, 59(10), 1 - 23. doi:http://dx.doi.org/10.18637/jss.v059.i10
]

- Supported by the *tidyverse*

- Allows piping `%>%` structures 

]

---
class: center, middle

.pull-left-70[
![](https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/sf.png)
.footnote[
Artwork by [@allison_horst](https://twitter.com/allison_horst)
]
]

.pull-right-30[

### **`sf` package**

Simple features for R

Spatial vector data (points, lines and polygons)

Compatible with *tidy* workflows

S3 classes
]
---
class: center, middle

.pull-left-70[
![:scale 80%](https://www.r-graph-gallery.com/339-circular-dendrogram-with-ggraph_files/figure-html/thecode8-1.png)
.footnote[
Plot from [R GRaph Gallery](https://www.r-graph-gallery.com/339-circular-dendrogram-with-ggraph.html)
]
]

.pull-right-30[

### **`tidygraph` package**
![:scale 10%](https://avatars3.githubusercontent.com/u/3735184?s=200&v=4)
 Interfaces with [`igraph`](https://igraph.org/r/)  
 
![:scale 8%](https://github.com/tidyverse/dplyr/raw/master/man/figures/logo.png)
 Supports [`dplyr`](https://dplyr.tidyverse.org/) *verbs* 

![:scale 8%](https://raw.githubusercontent.com/thomasp85/tidygraph/master/man/figures/logo.png)
 Introduces new *verbs* specific to network data (e.g. `morph`, `bind_graphs`, `graph_join`)

![:scale 8%](https://github.com/thomasp85/ggraph/raw/master/man/figures/logo.png)
 Allows network visualization via [`ggraph`](https://ggraph.data-imaginist.com/)
]

---
class: center, middle

## So, let's dive in...

---
### Installation 

```{r, eval = F}
remotes::install_github("luukvdmeer/sfnetworks")
library(sfnetworks)
```

---
class: center, middle

### `sfnetwork` class and methods

---

`r chunk_reveal(chunk_name = "object", break_type = "user", display_type = "both")`

```{r object, include = F}
# `sfnetworks` pre-loaded LINESTRING  
# `sf` object for Roxel, NRW, Germany
roxel %>% #BREAK
  # convert to an `sfnetwork` object
  as_sfnetwork() %>% #BREAK
  class() #BREAK
```

---

`r chunk_reveal(chunk_name = "sfnetworks_options", break_type = "non_seq", display_type = "both")`

```{r sfnetworks_options, include = F}
roxel %>% 
  as_sfnetwork(
    directed = F, #BREAK2
    edges_as_lines = F #BREAK3
  ) #BREAK
```

The construction function has two main options...

---

`r chunk_reveal(chunk_name = "plot", break_type = "non_seq", display_type = "both")`

```{r plot, include = F, dev.args = list(bg = 'transparent')}
par(mar = c(1, 1, 1, 1), bg = NA)
roxel %>% 
  as_sfnetwork(
    directed = F,
    edges_as_lines = F #BREAK2
  ) %>% #BREAK
  plot() #BREAK
```

which are better observed when plotted!

---

## What is out there already?

--

- [dodgr](https://atfutures.github.io/dodgr/)

--

- [cppRouting](https://github.com/vlarmet/cppRouting)

--

- [shp2graph](https://r-forge.r-project.org/projects/shp2graph)

--

- [spnetwork](https://github.com/edzer/spnetwork)

--

- [stplanr](https://docs.ropensci.org/stplanr/)

--

- ...

---

background-image: url(https://pbs.twimg.com/media/EZvQNJlWoAE4D_c?format=jpg&name=4096x4096)

# Applications 

--

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>


Many potential applications including:

Transport planning/modelling (Robin), Road safety (Andrea), River network analysis (e.g. Water quality research, Flooding research, Aquatic ecology) Electricity network analysis, Social network analysis, Many More!

---

### Transport networks are spatial networks

Spatial network representation in R:

![](https://raw.githubusercontent.com/cyipt/popupCycleways/master/figures/mapout.png)

---

### Actual plans from Leeds City Council


![](https://pbs.twimg.com/media/EZ_-A0dXgAAlBzt?format=png&name=900x900)

---

### Example: where to put 'pop-up' cycleways? Source: [www.cyipt.bike](https://www.cyipt.bike/rapid)

<!-- ![](https://raw.githubusercontent.com/cyipt/popupCycleways/master/figures/facet-output.png) -->

```{r, out.width="70%", echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/cyipt/popupCycleways/master/figures/facet-output.png")
```

---

## Necessary ingredients to prioritise new infrastructure

.pull-left[

- Current travel patterns
- Road attribute data 
- Potential usage levels
- Impact on overall network

]

.pull-right[

![](https://raw.githubusercontent.com/npct/pct-team/master/figures/go-dutch-leeds-purpose.png)

]

--

Source: https://www.pct.bike/

---

## Getting from A to B

---

##  Another example: formatting `sfnetwork` data for a road safety model

We can use `sf`, `tidygraph`, `igraph` and several other packages for: 

--

- summarizing the spatial dimension of the road network using several metrics (`tidygraph`); 

--

- extracting the adjacency matrix of the edges, which is typically one of the ingredients in a spatial model (`igraph`); 

--

- subsetting the road network considering only a particular geographical area (`sf`).  
<!-- summarize the spatial dimension of the road network through several metrics and adjacency matrices.  -->

--

Let's see an example but first we need to create the `sfnetwork` version of `roxel` data: 

```{r}
net <- as_sfnetwork(roxel, directed = FALSE)
```

```{r, include=FALSE}
library(tmap)
library(sf)
```

---
class: center, middle

### Summarizing Graph Characteristics

---

`r chunk_reveal(chunk_name = "nodes_degree", break_type = "user", display_type = "both", width_code = "48%", width_output = "50%")`

```{r nodes_degree, include=FALSE}
# Estimate nodes centrality degree
net <- net %>% #BREAK
  activate("nodes") %>% #BREAK
  mutate(degree = centrality_degree()) #BREAK

# Plot with tmap. We need to escape the nodes and 
# edges dimension and rebuild the sf structure.
tm_shape(net %>% activate("edges") %>% st_as_sf()) + 
  tm_lines() + #BREAK
tm_shape(net %>% activate("nodes") %>% st_as_sf()) + 
  tm_dots(
    size = 0.2,
    col = "degree", 
    as.count = TRUE, 
    palette = "viridis", 
    title = ""
  ) + 
tm_layout(legend.text.size = 2)
```

---

`r chunk_reveal(chunk_name = "edge_betweenness", break_type = "user", display_type = "both", width_code = "48%", width_output = "50%")`

```{r edge_betweenness, include=FALSE}
# Estimate edges centrality betweenness
net <- net %>% 
  activate("edges") %>% #BREAK
  mutate(
    lengths = st_length(.),
    betweenness = centrality_edge_betweenness(lengths)
    ) #BREAK

# Plot with tmap. We need to escape the nodes and 
# edges dimension and rebuild the sf structure.
tm_shape(net %>% activate("edges") %>% st_as_sf()) + 
  tm_lines(
    n = 8,
    scale = 2,
    col = "betweenness", 
    palette = "viridis", 
    legend.col.show = FALSE
    ) +
tm_shape(net %>% activate("nodes") %>% st_as_sf()) + 
  tm_dots(size = 0.1)
```

---

### Extracting the Adjacency Matrix of the edges


We can use `igraph` and `make_line_graph`! The `line graph` of a network object is obtained by inverting the nodes with the edges. We can apply this powerful idea to extract and visualize the `first-order binary adjacency matrix of the edges`. This type of matrix is used by a CAR or BYM spatial model. 

```{r, include=FALSE}
library(igraph)
library(Matrix)
```

---

`r chunk_reveal(chunk_name = "line_graph", break_type = "user", display_type = "both", width_code = "60%", width_output = "35%", title = "###First order binar adjacency", split = 50)`

```{r line_graph, include = FALSE}
# Create the line graph
net_line_graph <- make_line_graph(net) #BREAK

# Extract the first order binary adjacency matrix 
first_order_binary_adjacency <- net_line_graph %>% 
  as_adjacency_matrix() #BREAK

image(first_order_binary_adjacency[sample(1:851), ])
```

---

`r chunk_reveal(chunk_name = "line_graph2", break_type = "user", display_type = "both", width_code = "55%", width_output = "42%", title = "###Second order binar adjacency", split = 50)`

```{r line_graph2, include=FALSE}
# Similar idea for second order binary adjacency
ego2_net <- ego(net_line_graph, 2) #BREAK

second_order_binary_adjacency <- ego2_net %>% 
  graph_from_adj_list() %>% 
  as_adjacency_matrix() #BREAK

image(second_order_binary_adjacency[sample(1:851), ])
```

